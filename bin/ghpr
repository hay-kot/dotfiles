#!/usr/bin/env bash
# Usage:
#   ghpr                    # edit current branch PR
#   ghpr <PR-NUMBER>        # edit specific PR by number
#   ghpr labels             # edit labels for current branch PR
#   ghpr labels <PR-NUMBER> # edit labels for specific PR
#
# Edit GitHub PR title, description, or labels
set -euo pipefail

# Helper function to fetch PR info
fetch_pr() {
  local pr_arg="$1"
  local fields="$2"
  if [[ -z "$pr_arg" ]]; then
    gh pr view --json "$fields"
  else
    gh pr view "$pr_arg" --json "$fields"
  fi
}

# Parse arguments
mode="edit"
pr_number=""

if [[ $# -ge 1 ]] && [[ "$1" == "labels" ]]; then
  mode="labels"
  shift
  if [[ $# -eq 1 ]]; then
    pr_number="$1"
  fi
elif [[ $# -eq 1 ]]; then
  pr_number="$1"
fi

# Handle labels mode
if [[ "$mode" == "labels" ]]; then
  # Fetch PR info and repo labels
  pr_json=$(gum spin --spinner dot --title "Fetching PR..." -- fetch_pr "$pr_number" "number,labels")
  pr_number=$(jq -r '.number' <<<"$pr_json")
  current_labels=$(jq -r '.labels[].name' <<<"$pr_json")

  # Fetch all available labels in repo
  all_labels=$(gum spin --spinner dot --title "Fetching repository labels..." -- gh label list --json name --jq '.[].name')

  # Build gum choose command with pre-selected labels
  choose_args=()
  while IFS= read -r label; do
    choose_args+=("$label")
  done <<< "$all_labels"

  selected_args=()
  while IFS= read -r label; do
    [[ -n "$label" ]] && selected_args+=("--selected=$label")
  done <<< "$current_labels"

  # Show gum choose for label selection
  if [[ ${#selected_args[@]} -gt 0 ]]; then
    selected_labels=$(gum choose --no-limit "${selected_args[@]}" "${choose_args[@]}" || true)
  else
    selected_labels=$(gum choose --no-limit "${choose_args[@]}" || true)
  fi

  if [[ -z "$selected_labels" ]] && [[ ${#selected_args[@]} -eq 0 ]]; then
    echo "Cancelled"
    exit 0
  fi

  # Update PR labels
  if [[ -z "$selected_labels" ]]; then
    # Remove all labels
    if [[ -n "$current_labels" ]]; then
      gum spin --spinner dot --title "Removing all labels..." -- gh pr edit "$pr_number" --remove-label "$(echo "$current_labels" | tr '\n' ',')"
      echo "All labels removed from PR #$pr_number"
    else
      echo "No changes made"
    fi
  else
    # Update with selected labels
    label_list=$(echo "$selected_labels" | tr '\n' ',' | sed 's/,$//')
    gum spin --spinner dot --title "Updating labels..." -- gh pr edit "$pr_number" --add-label "$label_list"
    echo "Updated labels for PR #$pr_number"
  fi

  exit 0
fi

# Edit mode: Fetch current PR info or handle creation
pr_exists=true
if ! pr_json=$(gum spin --spinner dot --title "Fetching PR..." -- fetch_pr "$pr_number" "number,title,body" 2>&1); then
  # No PR exists, will create new one
  pr_exists=false

  # Try to find PR template using fd (case insensitive, include hidden)
  template_body=""
  if template_path=$(fd -t f -i -H 'pull_request_template.md' . 2>/dev/null | head -1); then
    [[ -n "$template_path" ]] && template_body=$(cat "$template_path")
  fi

  pr_json=$(jq -n --arg body "$template_body" '{number:null,title:"",body:$body}')
fi

if [[ "$pr_exists" == true ]]; then
  pr_number=$(jq -r '.number' <<<"$pr_json")
fi

# Convert to markdown with frontmatter (strip carriage returns from gh output)
original_md=$(jq '{title: (.title | gsub("\r"; "")), "$body": ((.body // "") | gsub("\r"; ""))}' <<<"$pr_json" | mdparse)

# Create temp file with current content
tmpfile=$(mktemp)
trap "rm -f $tmpfile" EXIT
echo "$original_md" > "$tmpfile"

# Open in Neovim
nvim "$tmpfile"

# Parse edited content back to JSON
edited_json=$(mdparse "$tmpfile")
new_title=$(jq -r '.title' <<<"$edited_json")
new_body=$(jq -r '."$body" // ""' <<<"$edited_json")

original_title=$(jq -r '.title' <<<"$pr_json")
original_body=$(jq -r '.body // ""' <<<"$pr_json")

# Check if anything changed
if [[ "$new_title" == "$original_title" ]] && [[ "$new_body" == "$original_body" ]]; then
  echo "No changes made"
  exit 0
fi

# Handle creation vs update
if [[ "$pr_exists" == false ]]; then
  # Creating a new PR
  if [[ -z "$new_title" ]]; then
    echo "Error: PR title cannot be empty"
    exit 1
  fi

  # Confirm creation
  gum confirm "Create PR: $new_title?" || {
    echo "Cancelled"
    exit 0
  }

  # Create the PR
  pr_url=$(gum spin --spinner dot --title "Creating PR..." -- gh pr create --title "$new_title" --body "$new_body")
  echo "Created PR: $pr_url"
else
  # Updating existing PR
  if [[ "$new_title" != "$original_title" ]]; then
    gum spin --spinner dot --title "Updating title..." -- gh pr edit "$pr_number" --title "$new_title"
    echo "Updated title"
  fi

  if [[ "$new_body" != "$original_body" ]]; then
    gum spin --spinner dot --title "Updating body..." -- gh pr edit "$pr_number" --body "$new_body"
    echo "Updated body"
  fi

  echo "PR #$pr_number updated"
fi
