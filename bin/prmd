#!/usr/bin/env bash
# Usage:
#   ./prmd.sh                 # uses current branch PR (markdown)
#   ./prmd.sh --plain         # uses current branch PR (plain text)
#   ./prmd.sh <PR-URL>        # uses explicit PR URL (markdown)
#   ./prmd.sh --plain <PR-URL> # uses explicit PR URL (plain text)
#
#   Generate markdown or plain text links for PRs to share
set -euo pipefail

# Check for --plain flag
plain=false
if [[ $# -ge 1 ]] && [[ "$1" == "--plain" ]]; then
  plain=true
  shift
fi

if [[ $# -eq 1 ]]; then
  url="$1"
  # Extract owner, repo, PR number from URL
  if [[ "$url" =~ github.com/([^/]+)/([^/]+)/pull/([0-9]+) ]]; then
    owner="${BASH_REMATCH[1]}"
    repo="${BASH_REMATCH[2]}"
    pr_number="${BASH_REMATCH[3]}"
  else
    echo "Invalid GitHub PR URL: $url" >&2
    exit 1
  fi
  # Fetch PR metadata using GitHub API
  json="$(gum spin --spinner dot --title "Fetching PR metadata..." -- gh api "repos/$owner/$repo/pulls/$pr_number")"
  title="$(jq -r '.title' <<<"$json")"
  additions="$(jq -r '.additions' <<<"$json")"
  deletions="$(jq -r '.deletions' <<<"$json")"
else
  # No URL provided, use current branch PR
  repo=$(basename -s .git "$(git config --get remote.origin.url)")
  out=$(gum spin --spinner dot --title "Fetching current branch PR..." -- gh pr view --json title,additions,deletions,url --jq '.title + "|" + (.additions|tostring) + "|" + (.deletions|tostring) + "|" + .url')
  IFS='|' read -r title additions deletions url <<< "$out"
fi

# Format output based on plain flag
if [[ "$plain" == "true" ]]; then
  # Plain text format for text messages
  result="[$repo] $title (+${additions}, -${deletions})\n$url"
else
  # Markdown/Slack format
  text="[$repo] $title \`(+${additions}, -${deletions})\`"
  result="[$text]($url)"
fi
echo -e "$result"

# Copy to clipboard if on macOS
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo -e "$result" | pbcopy
fi
