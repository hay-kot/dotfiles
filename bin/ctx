#!/usr/bin/env bash
# Usage:
#   ctx ls     - list files grouped by directory with modified time
#   ctx <cmd>  - forward to hive ctx <cmd>
#
# Wrapper around hive ctx with custom ls command
set -euo pipefail

CTX_BASE="${XDG_DATA_HOME:-$HOME/.local/share}/hive/context"

get_repo_path() {
  local remote
  remote=$(git remote get-url origin 2>/dev/null || echo "")
  [[ -z "$remote" ]] && return
  echo "$remote" | sed -E 's#^(git@[^:]+:|https?://[^/]+/)##' | sed 's/\.git$//'
}

get_ctx_dir() {
  local repo_path
  repo_path=$(get_repo_path)
  [[ -z "$repo_path" ]] && return
  echo "$CTX_BASE/$repo_path"
}

cmd_ls() {
  local ctx_dir
  ctx_dir=$(get_ctx_dir)

  if [[ -z "$ctx_dir" ]]; then
    echo "Error: not in a git repository with remote origin"
    exit 1
  fi

  if [[ ! -d "$ctx_dir" ]]; then
    echo "No context directory. Run 'hive ctx init' first"
    exit 0
  fi

  local files
  files=$(find "$ctx_dir" -type f ! -name '.DS_Store' 2>/dev/null | sort)

  if [[ -z "$files" ]]; then
    echo ".hive/ (empty)"
    exit 0
  fi

  local max_len=0
  while read -r file; do
    rel_path="${file#"$ctx_dir"/}"
    full_path="@.hive/$rel_path"
    (( ${#full_path} > max_len )) && max_len=${#full_path}
  done <<< "$files"

  local current_dir=""
  while read -r file; do
    rel_path="${file#"$ctx_dir"/}"
    dir=$(dirname "$rel_path")

    if [[ "$dir" != "$current_dir" ]]; then
      if [[ "$dir" == "." ]]; then
        echo ".hive/"
      else
        echo "$dir/"
      fi
      current_dir="$dir"
    fi

    full_path="@.hive/$rel_path"
    mod_time=$(stat -f '%Sm' -t '%b %d' "$file" 2>/dev/null || echo "")
    printf "  %-${max_len}s  %s\n" "$full_path" "$mod_time"
  done <<< "$files"
}

case "${1:-}" in
  ls)
    cmd_ls
    ;;
  "")
    echo "Usage: ctx <ls|init|prune|kv|...>"
    echo "       ctx ls - list context files"
    echo "       ctx <cmd> - forwarded to 'hive ctx <cmd>'"
    exit 1
    ;;
  *)
    exec hive ctx "$@"
    ;;
esac
