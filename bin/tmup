#!/usr/bin/env bash
set -euo pipefail

conffile="$HOME/.config/wezup/wezup.json"
cwdirname=$(basename "$(pwd)")

# Try exact match first, then prefix match
contents=$(jq --arg dir "$cwdirname" '.[$dir]' "$conffile")

if [ "$contents" = "null" ] || [ -z "$contents" ]; then
    # Find a key that is a prefix of the current directory name
    matched_key=$(jq -r --arg dir "$cwdirname" 'keys[] | select($dir | startswith(.))' "$conffile" | head -1)
    if [ -n "$matched_key" ]; then
        contents=$(jq --arg key "$matched_key" '.[$key]' "$conffile")
    fi
fi

if [ "$contents" = "null" ] || [ -z "$contents" ]; then
    echo "Error: No matching entry found for directory '$cwdirname' in $conffile"
    exit 1
fi

# Iterate through the array of tabs
echo "$contents" | jq -c '.[]' | while read -r tab; do
    tab_title=$(echo "$tab" | jq -r '.pane_title')
    cmd=$(echo "$tab" | jq -r '.cmd // empty')

    # Create new window with name
    tmux new-window -n "$tab_title"

    # If there's a command, send it
    if [ -n "$cmd" ]; then
        tmux send-keys "$cmd" Enter
    fi
done

# Go back to first window
tmux select-window -t :0
